<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GUTBOT ‚Äî Chat</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Poppins:wght@600;700&display=swap" rel="stylesheet">

  <style>
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #E6FAF8, #D7EEFB);
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* Top bar */
    .top-bar {
      background: #ffffffcc;
      backdrop-filter: blur(6px);
      padding: 14px 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .top-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .top-left img {
      width: 38px;
      height: 38px;
    }

    .top-left h2 {
      font-family: 'Poppins', sans-serif;
      font-size: 1.3rem;
      color: #0E2A47;
      margin: 0;
    }

    .top-right {
      font-size: 1.4rem;
    }

    /* Chat area */
    .chat-area {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      scroll-behavior: smooth;
    }

    .message {
      max-width: 80%;
      margin-bottom: 14px;
      padding: 14px 18px;
      border-radius: 18px;
      animation: fadeInUp 0.4s ease;
      line-height: 1.5;
      word-wrap: break-word;
      font-size: 1rem;
    }

    .bot {
      background: #D7F5E9;
      align-self: flex-start;
      color: #0E2A47;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }

    .user {
      background: #CBE3F3;
      align-self: flex-end;
      color: #0E2A47;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Typing indicator */
    .typing {
      display: flex;
      gap: 6px;
      margin-bottom: 14px;
      align-self: flex-start;
    }
    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(82, 167, 217, 0.6);
      animation: dot 1.2s infinite;
    }
    .dot:nth-child(2){animation-delay:.12s}
    .dot:nth-child(3){animation-delay:.24s}
    @keyframes dot{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}

    /* Input bar */
    .input-bar {
      display: flex;
      align-items: center;
      padding: 12px;
      background: #ffffffcc;
      backdrop-filter: blur(6px);
      border-top: 1px solid #cfe5ef;
    }

    .input-bar input {
      flex: 1;
      padding: 12px 18px;
      border: 1px solid #a7d9cb;
      border-radius: 30px;
      outline: none;
      font-size: 1rem;
      transition: 0.2s ease;
    }

    .input-bar input:focus {
      border-color: #52A7D9;
      box-shadow: 0 0 6px rgba(82, 167, 217, 0.3);
    }

    .input-buttons {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-left: 8px;
    }

    .send-btn, .mic-btn {
      background: #6CC7A1;
      color: white;
      border: none;
      width: 46px;
      height: 46px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }

    .send-btn:hover, .mic-btn:hover {
      background: #52A7D9;
      transform: scale(1.1);
    }

    .mic-btn.listening {
      background: #FF4B4B;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255, 75, 75, 0.4); }
      70% { box-shadow: 0 0 0 15px rgba(255, 75, 75, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 75, 75, 0); }
    }

    /* Scrollbar styling */
    .chat-area::-webkit-scrollbar {
      width: 6px;
    }
    .chat-area::-webkit-scrollbar-thumb {
      background-color: rgba(0,0,0,0.2);
      border-radius: 6px;
    }
  </style>

  <script>
    window.GUTBOT_CONFIG = {
      API_BASE: "{{BACKEND_URL}}",
      API_KEY: ""
    };
  </script>
</head>

<body>

  <!-- Top Bar -->
  <div class="top-bar">
    <div class="top-left">
      <img src="your-logo.png" alt="GUTBOT Logo">
      <h2>GUTBOT</h2>
    </div>
    <div class="top-right">ü§ñ</div>
  </div>

  <!-- Chat Area -->
  <div class="chat-area" id="messages">
    <div class="message bot">Hi üëã I'm GutBot ‚Äî here to help with your health. How are you feeling today?</div>
    <div id="typing" class="typing" style="display:none;">
      <div class="dot"></div>
      <div class="dot"></div>
      <div class="dot"></div>
    </div>
  </div>

  <!-- Input Bar -->
  <div class="input-bar">
    <input type="text" id="userInput" placeholder="Type or speak your question..." autocomplete="off">
    <div class="input-buttons">
      <button class="mic-btn" id="micButton" title="Voice input">üé§</button>
      <button class="send-btn" id="sendButton" title="Send">‚û§</button>
    </div>
  </div>

  <!-- JS Logic (original integrations preserved) -->
  <script>
  (function () {
    'use strict';

    const CONFIG = window.GUTBOT_CONFIG || {};
    const PLACEHOLDER = "{{BACKEND_URL}}";
    const apiBase = (
      CONFIG.API_BASE && CONFIG.API_BASE !== PLACEHOLDER
        ? CONFIG.API_BASE.replace(/\/$/, '')
        : ''
    ).trim();
    const apiKey = (CONFIG.API_KEY || '').trim();

    const userInput = document.getElementById('userInput');
    const sendButton = document.getElementById('sendButton');
    const micButton = document.getElementById('micButton');
    const messages = document.getElementById('messages');
    const typing = document.getElementById('typing');

    // Session
    function genSessionId() {
      return 'sess-' + Date.now().toString(36) + '-' + Math.floor(Math.random() * 1e9).toString(36);
    }
    const SESSION_KEY = 'gutbot_session_id';
    let sessionId = localStorage.getItem(SESSION_KEY) || null;
    if (!sessionId) {
      sessionId = genSessionId();
      localStorage.setItem(SESSION_KEY, sessionId);
    }

    // Utilities
    function timestamp(){
      const now = new Date();
      let hrs = now.getHours();
      const ampm = hrs >= 12 ? 'PM' : 'AM';
      hrs = hrs % 12 || 12;
      let mins = now.getMinutes();
      mins = mins < 10 ? '0'+mins : mins;
      return `${hrs}:${mins} ${ampm}`;
    }

    function renderSafeHtmlFromText(text) {
      const escaped = String(text)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
      return escaped.replace(/\n/g, '<br>');
    }

    function addMessage(text, isUser=false){
      const wrapper = document.createElement('div');
      wrapper.className = 'message ' + (isUser ? 'user' : 'bot');
      wrapper.innerHTML = renderSafeHtmlFromText(text);
      messages.insertBefore(wrapper, typing);
      messages.scrollTop = messages.scrollHeight;
    }

    function showTyping(show){
      typing.style.display = show ? 'flex' : 'none';
    }

    function setBusy(isBusy){
      if (isBusy) {
        userInput.setAttribute('disabled', 'disabled');
        sendButton.setAttribute('disabled', 'disabled');
        sendButton.style.opacity = '0.6';
      } else {
        userInput.removeAttribute('disabled');
        sendButton.removeAttribute('disabled');
        sendButton.style.opacity = '';
        userInput.focus();
      }
    }

    // Networking
    function fetchWithTimeout(resource, options = {}, timeout = 20000) {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);
      options.signal = controller.signal;
      return fetch(resource, options).finally(() => clearTimeout(id));
    }

    async function postJsonWithRetries(url, body, maxAttempts = 3) {
      let attempt = 0;
      let wait = 500;
      while (attempt < maxAttempts) {
        attempt++;
        try {
          const headers = { "Content-Type": "application/json" };
          if (apiKey) headers["X-API-Key"] = apiKey;
          const res = await fetchWithTimeout(url, {
            method: "POST",
            headers,
            body: JSON.stringify(body)
          }, 20000);
          if (!res.ok) {
            if (res.status >= 500 || res.status === 429) {
              const text = await res.text().catch(()=> '');
              throw { transient: true, status: res.status, payload: text };
            } else {
              const json = await res.json().catch(()=>null);
              throw { transient: false, status: res.status, payload: json || text || `HTTP ${res.status}` };
            }
          }
          const data = await res.json().catch(()=>null);
          return { ok: true, data };
        } catch (err) {
          const isAbort = (err && err.name === 'AbortError') || (err && err.type === 'aborted');
          if (isAbort || (err && (err.transient || err instanceof TypeError))) {
            if (attempt < maxAttempts) {
              await new Promise(r => setTimeout(r, wait));
              wait *= 2;
              continue;
            } else {
              return { ok: false, error: 'network_timeout_or_unreachable' };
            }
          } else {
            return { ok: false, error: err };
          }
        }
      }
      return { ok: false, error: 'unknown' };
    }

    async function sendToBackend(msg) {
      showTyping(true);
      setBusy(true);

      const endpoint = (apiBase || '') + '/chat';
      const payload = { message: msg, session_id: sessionId };

      try {
        const result = await postJsonWithRetries(endpoint, payload, 3);
        showTyping(false);
        setBusy(false);
        if (result.ok && result.data) {
          const resp = result.data.response || result.data.reply || (typeof result.data === 'string' ? result.data : null);
          if (resp) {
            addMessage(resp, false);
          } else {
            addMessage("‚ö†Ô∏è Unexpected server response.", false);
          }
        } else {
          if (result.error && typeof result.error === 'object' && result.error.status === 401) {
            addMessage("üîí Authentication required (invalid API key).", false);
          } else if (result.error === 'network_timeout_or_unreachable') {
            addMessage("‚ùå Network timeout or server unreachable.", false);
          } else {
            const errMsg = (result.error && (result.error.payload || result.error)) || "Server error.";
            addMessage("‚ùå " + String(errMsg), false);
          }
        }
      } catch (err) {
        showTyping(false);
        setBusy(false);
        addMessage("‚ùå Unexpected error while sending message.", false);
        console.error(err);
      }
    }

    // UI events
    sendButton.addEventListener('click', function(){
      const raw = userInput.value || '';
      const msg = raw.trim();
      if (!msg) return;
      addMessage(msg, true);
      userInput.value = '';
      sendToBackend(msg);
    });

    userInput.addEventListener('keypress', function(e){
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendButton.click();
      }
    });

    // Speech Recognition
    let recognition = null;
    if(('SpeechRecognition' in window) || ('webkitSpeechRecognition' in window)){
      recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = 'en-US';
      recognition.onresult = function(event){
        const transcript = event.results[0][0].transcript;
        if(userInput) userInput.value = transcript;
        micButton.classList.remove('listening');
      };
      recognition.onerror = function(){ micButton.classList.remove('listening'); };
      recognition.onend = function(){ micButton.classList.remove('listening'); };

      micButton.addEventListener('click', function(){
        if(micButton.classList.contains('listening')){
          recognition.stop();
          micButton.classList.remove('listening');
        } else {
          recognition.start();
          micButton.classList.add('listening');
        }
      });
    } else {
      micButton.style.display = 'none';
    }

    console.info('GutBot chat initialized', { apiBase, sessionId });
  })();
  </script>
</body>
</html>
