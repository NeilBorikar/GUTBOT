<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GutBot — Conversation</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Space+Grotesk:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f6f9ff;
      --surface:rgba(255,255,255,0.98);
      --muted:#566276;
      --ink:#071227;
      --accent:#0b76d1;
      --accent-2:#7c4dff;
      --green:#00c48c;
      --glass-border:rgba(11,118,209,0.05);
      --glass-shadow:0 18px 50px rgba(12,34,64,0.06);
      --radius:14px;
      --focus:3px solid rgba(11,118,209,0.12);
      --ease:cubic-bezier(.2,.9,.2,1);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{font-family:'Space Grotesk',system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--ink);min-height:100vh;background:linear-gradient(180deg,var(--bg),#fff);display:flex;flex-direction:column}

    .skip{position:absolute;left:-9999px}
    .skip:focus{left:18px;top:18px;padding:8px;background:white;border-radius:8px;box-shadow:var(--glass-shadow)}

    header{display:flex;align-items:center;gap:14px;padding:16px 22px;background:var(--surface);border-bottom:1px solid var(--glass-border);box-shadow:var(--glass-shadow)}
    .logo{width:52px;height:52px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:grid;place-items:center;color:white;font-weight:900}
    header h1{font-family:'Outfit';font-size:18px;font-weight:800}

    .stage{display:grid;grid-template-columns:320px 1fr;gap:22px;padding:22px;flex:1;align-items:start}

    .left{background:var(--surface);border-radius:12px;padding:14px;border:1px solid var(--glass-border);box-shadow:var(--glass-shadow)}
    .profile{display:flex;gap:12px;align-items:center}
    .avatar{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:grid;place-items:center;color:white;font-weight:900}
    .pill{padding:10px;border-radius:10px;background:white;border:1px solid rgba(10,10,20,0.03);cursor:pointer}

    .chat-wrap{display:flex;flex-direction:column;height:calc(100vh - 140px)}
    .messages{flex:1;overflow:auto;padding:22px;display:flex;flex-direction:column;gap:14px;border-radius:12px;background:linear-gradient(180deg,#fff,#fbfdff);border:1px solid var(--glass-border);box-shadow:0 10px 30px rgba(11,24,40,0.03)}

    .msg{max-width:78%;padding:14px 16px;border-radius:18px;font-size:15px;line-height:1.45;box-shadow:0 10px 30px rgba(16,24,40,0.04)}
    .bot{align-self:flex-start;background:linear-gradient(180deg,#fff,rgba(250,250,255,0.98));border:1px solid rgba(10,10,20,0.03);color:var(--ink)}
    .user{align-self:flex-end;background:linear-gradient(90deg,var(--accent),#2aa6ff);color:white;border:0}

    .meta{font-size:12px;color:var(--muted);margin-top:8px;text-align:right}

    .typing{display:flex;gap:8px;align-items:center}
    .dot{width:9px;height:9px;border-radius:50%;background:rgba(11,118,209,0.18);animation:dot 1.2s infinite}
    .dot:nth-child(2){animation-delay:.12s}
    .dot:nth-child(3){animation-delay:.24s}
    @keyframes dot{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}

    .composer{display:flex;gap:12px;padding:14px;border-radius:14px;background:var(--surface);align-items:center;border:1px solid var(--glass-border);margin-top:12px}
    .composer input{flex:1;padding:12px 14px;border-radius:12px;border:1px solid rgba(10,10,20,0.03);background:white;font-size:15px}
    .composer input:focus{outline:var(--focus)}
    .mic{border:0;background:transparent;padding:8px;border-radius:10px;cursor:pointer}
    .send{background:linear-gradient(90deg,var(--accent),#2aa6ff);color:white;padding:10px 14px;border-radius:12px;border:0;font-weight:800;cursor:pointer}

    /* background "photo" strip at top of chat for context (health images-looking SVG tiles) */
    .photo-strip{position:fixed;left:0;right:0;top:68px;height:110px;pointer-events:none;z-index:-3;opacity:0.18}
    .photo-strip svg{width:100%;height:100%;display:block}

    .judge-cta{display:none} /* kept to ensure compatibility with previous logic but hidden */

    .blob{position:fixed;border-radius:50%;filter:blur(56px);opacity:0.12;pointer-events:none}
    .blob.l{width:360px;height:360px;left:-120px;top:22%;background:linear-gradient(135deg,var(--accent),var(--accent-2))}
    .blob.r{width:280px;height:280px;right:-100px;bottom:6%;background:linear-gradient(135deg,#00d38a,rgba(11,118,209,0.08))}

    @media (max-width:980px){.stage{grid-template-columns:1fr}.blob{display:none}.photo-strip{display:none}}
    @media (prefers-reduced-motion:reduce){.dot{animation:none}.blob{display:none}.photo-strip{opacity:0.05}}
  </style>
</head>
<body>
  <a class="skip" href="#messages">Skip to messages</a>

  <!-- soft top photo-strip (SVG collage feel like photos) -->
  <div class="photo-strip" aria-hidden="true">
    <svg viewBox="0 0 1600 110" preserveAspectRatio="xMidYMid slice">
      <defs>
        <linearGradient id="pg1" x1="0" x2="1"><stop offset="0" stop-color="#0b76d1"/><stop offset="1" stop-color="#7c4dff"/></linearGradient>
      </defs>
      <g transform="translate(0,0)">
        <rect x="40" y="10" rx="10" ry="10" width="220" height="90" fill="#ffffff" stroke="rgba(10,10,20,0.02)"/>
        <g transform="translate(60,30)" fill="#0b76d1"><circle cx="18" cy="18" r="18"/></g>
        <rect x="300" y="10" rx="10" ry="10" width="220" height="90" fill="#ffffff" stroke="rgba(10,10,20,0.02)"/>
        <g transform="translate(320,30)" fill="#00c48c"><circle cx="18" cy="18" r="18"/></g>

        <rect x="820" y="10" rx="10" ry="10" width="260" height="90" fill="#ffffff" stroke="rgba(10,10,20,0.02)"/>
        <g transform="translate(840,30)" fill="#7c4dff"><circle cx="18" cy="18" r="18"/></g>
      </g>
    </svg>
  </div>

  <header>
    <div class="logo" aria-hidden="true">G</div>
    <div>
      <h1 style="margin:0;line-height:1">GutBot</h1>
      <small style="color:var(--muted)">Transcendent Health Interface</small>
    </div>
  </header>

  <main class="stage" role="main">
    <aside class="left" aria-label="Shortcuts">
      <div class="profile">
        <div class="avatar">G</div>
        <div>
          <div style="font-weight:800">Guest User</div>
          <small style="color:var(--muted)">Voice • Session Notes</small>
        </div>
      </div>

      <div style="margin-top:12px;display:flex;flex-direction:column;gap:10px">
        <button class="pill">New Consultation</button>
        <button class="pill">Saved Sessions</button>
        <button class="pill">Export Notes</button>
      </div>

      <div style="margin-top:14px;font-size:13px;color:var(--muted)">
        Tip: Press <strong>Ctrl/Cmd + K</strong> for quick actions.
      </div>
    </aside>

    <section class="chat-wrap" aria-label="Conversation area">
      <div id="messages" class="messages" aria-live="polite">
        <div class="msg bot">Hello! I'm your GutBot — here to help with digestion, symptoms and gentle advice.<div class="meta">12:45 PM</div></div>
        <div class="msg bot">How are you feeling today? Describe any symptoms or concerns.<div class="meta">12:46 PM</div></div>
        <div class="msg user">I've been having some stomach discomfort after meals.<div class="meta">12:47 PM</div></div>

        <div id="typing" class="msg bot" style="display:none">
          <div class="typing">
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
          </div>
        </div>
      </div>

      <div class="composer" role="region" aria-label="Message composer">
        <input id="userInput" placeholder="Type your health question or symptom..." aria-label="Message input" autocomplete="off">
        <button id="micButton" class="mic" aria-label="Voice input">🎤</button>
        <button id="sendButton" class="send" aria-label="Send message">Send</button>
      </div>
    </section>
  </main>

  <div class="blob l" aria-hidden="true"></div>
  <div class="blob r" aria-hidden="true"></div>

 <script>
document.addEventListener('DOMContentLoaded', function(){
  const userInput = document.getElementById('userInput');
  const sendButton = document.getElementById('sendButton');
  const micButton = document.getElementById('micButton');
  const messages = document.getElementById('messages');
  const typing = document.getElementById('typing');

  if(userInput) userInput.focus();

  function timestamp(){
    const now = new Date();
    let hrs = now.getHours();
    const ampm = hrs >= 12 ? 'PM' : 'AM';
    hrs = hrs % 12 || 12;
    let mins = now.getMinutes();
    mins = mins < 10 ? '0'+mins : mins;
    return `${hrs}:${mins} ${ampm}`;
  }

  function addMessage(text, isUser=false){
    const div = document.createElement('div');
    div.className = 'msg ' + (isUser ? 'user' : 'bot');
    div.innerHTML = `${text}<div class="meta">${timestamp()}</div>`;
    messages.insertBefore(div, typing);
    scrollIfNearBottom();
  }

  function scrollIfNearBottom(){
    const nearEnd = messages.scrollHeight - messages.scrollTop <= messages.clientHeight + 120;
    if(nearEnd) messages.scrollTo({ top: messages.scrollHeight, behavior: 'smooth' });
  }

  async function sendToBackend(msg){
    typing.style.display = 'block';
    scrollIfNearBottom();

    try {
      const response = await fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: msg })
      });

      const data = await response.json();
      typing.style.display = 'none';

      if(data && data.response){
      addMessage(data.response, false);
      } else {
      addMessage("⚠️ Sorry, I couldn’t understand the response.", false);
      }

    } catch (err) {
      typing.style.display = 'none';
      addMessage("❌ Server error. Please try again later.", false);
      console.error(err);
    }
  }

  if(sendButton && userInput){
    sendButton.addEventListener('click', function(){
      const msg = userInput.value.trim();
      if(!msg) return;
      addMessage(msg, true);
      userInput.value = '';
      userInput.focus();
      sendToBackend(msg);
    });
  }

  if(userInput){
    userInput.addEventListener('keypress', function(e){
      if(e.key === 'Enter') sendButton.click();
    });
  }

  // 🎤 Speech recognition (unchanged)
  let recognition = null;
  if(('SpeechRecognition' in window) || ('webkitSpeechRecognition' in window)){
    recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.lang = 'en-US';
    recognition.onresult = function(event){
      const transcript = event.results[0][0].transcript;
      if(userInput) userInput.value = transcript;
      micButton.classList.remove('listening');
    };
    recognition.onerror = function(){ micButton.classList.remove('listening'); };
    recognition.onend = function(){ micButton.classList.remove('listening'); };

    micButton.addEventListener('click', function(){
      if(micButton.classList.contains('listening')){
        recognition.stop();
        micButton.classList.remove('listening');
      } else {
        recognition.start();
        micButton.classList.add('listening');
      }
    });
  } else {
    if(micButton) micButton.style.display = 'none';
  }

  // Pointer parallax, quick actions, reduced motion → unchanged
});
</script>
